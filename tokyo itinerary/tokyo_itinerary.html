<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬ 5 æ—¥å®¢è£½åŒ–è¡Œç¨‹è¦åŠƒ (é›²ç«¯åŒæ­¥è¼•é‡ç‰ˆ)</title>
    
    <!-- PWA ç›¸é—œè¨­å®š -->
    <meta name="theme-color" content="#FDFCF5">
    
    <!-- iOS å°ˆç”¨è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ±äº¬5æ—¥">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/ricardo-4709/sec/refs/heads/main/tokyo%20itinerary/ginko_tower-192x192_Resize%20Image.png">

    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-gold': '#D4AF37',
                        'jp-gold-light': '#F3E5AB',
                        'jp-brown': '#594a4e',
                        'jp-red': '#C0392B',
                        'jp-cream': '#FDFCF5',
                    },
                    fontFamily: {
                        sans: ['Zen Old Mincho', 'Noto Serif TC', 'serif'],
                        serif: ['Zen Old Mincho', 'Noto Serif TC', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        html { scroll-behavior: smooth; }
        body {
            background-color: #FDFCF5;
            background-image: radial-gradient(#D4AF37 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            color: #594a4e;
            overflow-x: hidden;
            min-height: 100vh;
            overscroll-behavior-y: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .nav-btn {
            position: relative; padding: 0.35rem 1rem; margin-right: 0.25rem; font-size: 0.85rem; font-weight: 600; color: #594a4e;
            border: 1px solid #D4AF37; border-radius: 9999px; transition: all 0.3s ease; background-color: white; white-space: nowrap; flex-shrink: 0;
        }
        .nav-btn:hover, .nav-btn.active {
            background-color: #D4AF37; color: white; box-shadow: 0 2px 4px -1px rgba(212, 175, 55, 0.3); transform: translateY(-1px);
        }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .date-tab {
            display: block; width: 100%; text-align: center; padding: 0.75rem 0.25rem; border-right: 3px solid transparent; border-left: 0; border-bottom: 1px solid #e5e7eb;
            color: #594a4e; transition: all 0.3s; font-family: 'Zen Old Mincho', serif;
        }
        @media (min-width: 768px) { .date-tab { text-align: left; padding: 1rem 1.5rem; border-right: 0; border-left: 4px solid transparent; border-bottom: 0; } }
        .date-tab:hover { background-color: rgba(212, 175, 55, 0.1); }
        .date-tab.active { background-color: white; font-weight: bold; }
        @media (max-width: 767px) { .date-tab.active { border-right-color: #D4AF37; background-color: #fff; } }
        @media (min-width: 768px) { .date-tab.active { border-left-color: #D4AF37; box-shadow: 0 2px 10px rgba(0,0,0,0.05); } }
        .date-tab .day-num { font-size: 1rem; display: block; font-weight: bold; }
        .date-tab .day-week { font-size: 0.7rem; opacity: 0.8; display: block; margin-top: 2px; }
        @media (min-width: 768px) { .date-tab .day-num { font-size: 1.25rem; } .date-tab .day-week { font-size: 0.875rem; } }
        .timeline-container { position: relative; padding-left: 1rem; }
        @media (min-width: 768px) { .timeline-container { padding-left: 2rem; } }
        .detail-item { position: relative; padding-bottom: 1.5rem; border-left: 1px solid #D4AF37; padding-left: 1.25rem; }
        .detail-item:last-child { border-left: transparent; }
        .detail-item::before {
            content: ''; position: absolute; left: -5px; top: 0; width: 11px; height: 11px;
            background-color: #FDFCF5; border: 2px solid #D4AF37; border-radius: 50%;
        }
        .detail-time { font-family: 'Noto Serif TC', serif; color: #D4AF37; font-weight: bold; margin-bottom: 0.1rem; font-size: 0.85rem; }
        .detail-title { font-size: 1rem; font-weight: bold; color: #594a4e; margin-bottom: 0.25rem; }
        .detail-desc {
            font-size: 0.85rem; color: #666; line-height: 1.5; background-color: rgba(243, 229, 171, 0.15); padding: 0.5rem; border-radius: 0.5rem;
        }
        .recommend-tag {
            display: inline-block; margin-top: 0.25rem; background-color: #FCE7F3; color: #9D174D; font-size: 0.7rem; padding: 1px 6px; border-radius: 4px; border: 1px solid #FBCFE8;
        }
        .dining-list { margin-top: 0.5rem; background-color: #fff; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.4rem; }
        .dining-header { font-size: 0.7rem; font-weight: bold; color: #D4AF37; margin-bottom: 0.25rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.2rem; }
        .dining-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 0.25rem 0; border-bottom: 1px dashed #f3f4f6; }
        .dining-item:last-child { border-bottom: none; }
        .dining-name-link { font-weight: bold; color: #594a4e; font-size: 0.8rem; display: flex; align-items: center; text-decoration: none; transition: color 0.2s; }
        .dining-name-link:hover { color: #D4AF37; text-decoration: underline; }
        .dining-note { font-size: 0.7rem; color: #666; display: block; margin-top: 1px; }
        .dining-rating { font-size: 0.7rem; color: #d97706; background-color: #fef3c7; padding: 1px 4px; border-radius: 3px; white-space: nowrap; margin-left: 0.5rem; flex-shrink: 0; }
        .in-map-badge { font-size: 0.6rem; background-color: #dbeafe; color: #1e40af; padding: 0 3px; border-radius: 2px; margin-left: 3px; white-space: nowrap; }
        .shop-category { font-weight: bold; color: #D4AF37; font-size: 1rem; margin-top: 1rem; margin-bottom: 0.5rem; border-bottom: 2px solid #F3E5AB; padding-bottom: 0.25rem; }
        .shop-item { display: flex; align-items: flex-start; padding: 0.6rem; background: white; border: 1px solid #f3f4f6; border-radius: 0.5rem; margin-bottom: 0.5rem; transition: all 0.2s; }
        .shop-item:hover { box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-color: #D4AF37; }
        .shop-item.checked { opacity: 0.6; background-color: #f9fafb; }
        .shop-item.checked .shop-name { text-decoration: line-through; color: #9ca3af; }
        .shop-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: auto; white-space: nowrap; font-weight: bold; }
        .tag-drugstore { background-color: #fee2e2; color: #b91c1c; }
        .tag-variety { background-color: #fef3c7; color: #d97706; }
        .tag-fashion { background-color: #e0e7ff; color: #4338ca; }
        .tag-contact { background-color: #fce7f3; color: #be185d; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(89, 74, 78, 0.6); backdrop-filter: blur(2px); }
        .modal-content { background-color: #FDFCF5; margin: 10% auto; padding: 1.5rem; border: 1px solid #D4AF37; width: 90%; max-width: 500px; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .filter-btn.active { background-color: #594a4e; color: #FDFCF5; border-color: #594a4e; }
        .spot-item { transition: all 0.2s ease-in-out; cursor: pointer; border-left: 4px solid transparent; }
        .spot-item:hover { background-color: rgba(243, 229, 171, 0.3); }
        .spot-item.active-spot { background-color: rgba(212, 175, 55, 0.15); border-left-color: #D4AF37; }
        .loading-text { color: #D4AF37; font-size: 0.8rem; text-align: center; padding: 1rem; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .dist-badge { font-size: 0.65rem; background-color: #e5e7eb; color: #374151; padding: 2px 5px; border-radius: 999px; font-weight: bold; margin-left: auto; }
        .dist-near { background-color: #dcfce7; color: #166534; }
        
        /* About/Settings Modal Animation */
        #about-modal .modal-content {
            animation: zoomIn 0.3s ease-out;
        }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Add Item Section Styles */
        .add-form-group {
            background: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            display: none; 
            animation: fadeIn 0.3s ease-out;
        }
        .add-form-group.active {
            display: block;
        }
        .add-form-label {
            display: block;
            font-weight: bold;
            color: #594a4e;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            border-left: 3px solid #D4AF37;
            padding-left: 0.5rem;
        }
        .add-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            transition: border-color 0.2s;
        }
        .add-input:focus {
            outline: none;
            border-color: #D4AF37;
            ring: 2px solid rgba(212, 175, 55, 0.2);
        }
        .add-tab-btn {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 9999px;
            color: #6b7280;
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .add-tab-btn.active {
            background-color: #594a4e;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Badge for local only */
        .badge-local {
            font-size: 0.6rem; 
            color: #666;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 1px 6px; 
            border-radius: 4px;
        }
    </style>
</head>
<body class="font-serif">
    <nav class="sticky top-0 z-50 bg-jp-cream/95 backdrop-blur-md shadow-sm border-b border-jp-gold/20 pt-safe-top">
        <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
            <div class="flex flex-col items-center justify-center py-2">
                <div class="mb-2">
                    <h1 onclick="openAboutModal()" class="cursor-pointer text-xl sm:text-2xl font-bold text-jp-brown tracking-widest border-b-2 border-jp-gold pb-1 px-4 hover:opacity-80 transition select-none" title="é»æ“ŠæŸ¥çœ‹ç‰ˆæœ¬">TOKYO TRIP</h1>
                </div>
                <div id="navbar-scroll-container" class="flex flex-nowrap justify-start sm:justify-center gap-1 w-full overflow-x-auto no-scrollbar px-1 pb-1 scroll-smooth">
                    <button class="nav-btn active" data-section="checklist">è¡Œå‰æº–å‚™</button>
                    <button class="nav-btn" data-section="transport">äº¤é€šä½å®¿</button>
                    <button class="nav-btn" data-section="daily-itinerary">æ¯æ—¥è¡Œç¨‹</button>
                    <button class="nav-btn" data-section="map-list">æ—…ç¨‹åœ°åœ–</button>
                    <button class="nav-btn" data-section="shopping-list">è³¼ç‰©æ¸…å–®</button>
                    <button class="nav-btn border-jp-red text-jp-red font-bold" data-section="add-items">æ–°å¢é …ç›®</button>
                </div>
            </div>
        </div>
    </nav>
    <main id="main-content" class="max-w-6xl mx-auto py-1 px-2 sm:px-6 lg:px-8 pb-4">
        <section id="checklist" class="content-section active bg-white p-4 md:p-8 rounded-2xl shadow-lg border border-jp-gold/20">
            <h2 class="text-xl font-bold text-jp-brown mb-4 md:mb-8 flex items-center justify-center"><span class="text-jp-gold mr-3">âœ¦</span> è¡Œå‰æº–å‚™ <span class="text-jp-gold ml-3">âœ¦</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                <div class="bg-jp-gold-light/10 p-4 rounded-lg border border-jp-gold/20">
                    <h3 class="text-base font-bold text-jp-red mb-3 flex items-center">âš ï¸ å‹™å¿…é å…ˆé ç´„ / æ¶ç¥¨</h3>
                    <ul class="space-y-2 text-sm text-jp-brown list-disc list-inside">
                        <li><strong>SHIBUYA SKYï¼š</strong> 12/7 æ—¥è½å ´æ¬¡ (å·²è³¼è²· âœ…)ã€‚</li>
                        <li><strong>è»æ¸¯å·¡èˆªï¼š</strong> 12/6 12:00 èˆ¹ç­ã€‚</li>
                        <li><strong>æ°´ä¸Šå·´å£«ï¼š</strong> 12/8 æ·ºè‰ â†’ æµœé›¢å®®ã€‚</li>
                        <li><strong>ç“”ç (åˆé¤)ï¼š</strong> 12/5 12:15 (å·²è¨‚ä½)ã€‚</li>
                        <li><strong>äº¤é€šåˆ¸ï¼š</strong> N'EXã€å°ç”°æ€¥ã€Subway Ticketã€‚</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-base font-bold text-jp-brown">è¡Œææ¸…å–®</h3>
                            <span class="badge-local" title="æ­¤æ¸…å–®åƒ…å„²å­˜åœ¨æœ¬æ©Ÿ">ğŸ“± åƒ…æœ¬æ©Ÿ</span>
                        </div>
                        <div class="text-xs text-gray-500">å¯é»æ“Šç·¨è¼¯</div>
                    </div>
                    <div class="mb-2 text-xs text-gray-400 text-center border-b border-dashed pb-2">ğŸ’¡ å¦‚éœ€æ–°å¢ç‰©å“ï¼Œè«‹è‡³ä¸Šæ–¹é¸å–®çš„ã€Œæ–°å¢é …ç›®ã€é é¢</div>
                    <div id="luggage-list-container" class="space-y-1 max-h-[60vh] sm:max-h-[400px] overflow-y-auto pr-1">
                        <div class="text-center p-4 text-gray-400">æ­£åœ¨è®€å–æœ¬æ©Ÿè³‡æ–™...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Optimized Section: Add Items -->
        <section id="add-items" class="content-section bg-white p-4 md:p-8 rounded-2xl shadow-lg border border-jp-gold/20 min-h-[500px]">
            <h2 class="text-xl font-bold text-jp-brown mb-4 flex items-center justify-center"><span class="text-jp-gold mr-3">âœ¦</span> æ–°å¢é …ç›® <span class="text-jp-gold ml-3">âœ¦</span></h2>
            
            <!-- App-like Tab Switcher -->
            <div class="flex p-1 bg-gray-100 rounded-full mb-6 max-w-md mx-auto">
                <button class="add-tab-btn active" onclick="switchAddTab('spot')">æ–°å¢åœ°é»</button>
                <button class="add-tab-btn" onclick="switchAddTab('shop')">æ–°å¢è³¼ç‰©</button>
                <button class="add-tab-btn" onclick="switchAddTab('luggage')">æ–°å¢è¡Œæ</button>
            </div>

            <div class="max-w-md mx-auto">
                <!-- 1. æ–°å¢åœ°åœ–åœ°é» Form -->
                <div id="form-spot" class="add-form-group active border-l-4 border-l-jp-brown">
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-jp-brown mb-1 block">åœ°é»åç¨±</label>
                            <input id="add-spot-name" type="text" placeholder="ä¾‹å¦‚ï¼šæ™´ç©ºå¡”" class="add-input">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-jp-brown mb-1 block">åˆ†é¡</label>
                            <select id="add-spot-type" class="add-input bg-white h-10">
                                <option value="food">ç¾é£Ÿ (ç´…)</option>
                                <option value="shopping">è³¼ç‰© (é‡‘)</option>
                                <option value="sightseeing">æ™¯é» (è¤)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-jp-brown mb-1 block">å‚™è¨»</label>
                            <input id="add-spot-note" type="text" placeholder="è‹¥ç©ºç™½å°‡è‡ªå‹•å¡«å¯«" class="add-input">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 mb-1 block">Google Map é€£çµ (é¸å¡«)</label>
                            <input id="add-spot-map" type="text" placeholder="https://goo.gl/maps/..." class="add-input text-xs">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 mb-1 block">è‡ªè¨‚é€£çµ (é¸å¡«)</label>
                            <input id="add-spot-link" type="text" placeholder="å®˜ç¶²ã€IG..." class="add-input text-xs">
                        </div>
                        <button onclick="addNewSpot()" class="w-full bg-jp-brown text-white py-3 rounded-lg hover:bg-gray-700 transition font-bold mt-2 shadow-sm">ï¼‹ åŠ å…¥åœ°åœ–åˆ—è¡¨ (é›²ç«¯)</button>
                    </div>
                </div>

                <!-- 2. æ–°å¢è³¼ç‰©æ¸…å–® Form -->
                <div id="form-shop" class="add-form-group border-l-4 border-l-jp-gold">
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-jp-brown mb-1 block">å•†å“åç¨±</label>
                            <input id="add-shop-name" type="text" placeholder="ä¾‹å¦‚ï¼šåˆåˆ©ä»–å‘½" class="add-input">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-jp-brown mb-1 block">åˆ†é¡</label>
                            <select id="add-shop-category" class="add-input bg-white h-10">
                                <option value="è—¥å¦ä¿é¤Š">è—¥å¦ä¿é¤Š</option>
                                <option value="ç”Ÿæ´»é›œè²¨/é›»å™¨">ç”Ÿæ´»é›œè²¨/é›»å™¨</option>
                                <option value="æœé£¾é…ä»¶">æœé£¾é…ä»¶</option>
                                <option value="é›¶é£Ÿä¼´æ‰‹ç¦®">é›¶é£Ÿä¼´æ‰‹ç¦®</option>
                                <!-- å·²ç§»é™¤ç¾ç³éš±çœ¼ï¼Œæ”¹ä½µå…¥è—¥å¦ä¿é¤Š -->
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-jp-brown mb-1 block">è³¼è²·åœ°é»</label>
                            <div class="flex gap-1">
                                <input id="add-shop-location" type="text" placeholder="è‹¥ç©ºç™½å°‡è‡ªå‹•å¡«å¯«" class="add-input flex-grow mb-0">
                                <button onclick="searchLocationForShop()" class="bg-gray-100 border border-gray-300 rounded px-3 text-sm hover:bg-gray-200 transition mb-2" title="Googleæœå°‹åœ°é»åç¨±">ğŸ”</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-jp-brown mb-1 block">æ¨™ç±¤æ¨£å¼</label>
                            <select id="add-shop-tag" class="add-input bg-white h-10">
                                <option value="Drugstore">Drugstore (ç´…)</option>
                                <option value="Variety">Variety (é»ƒ)</option>
                                <option value="Fashion">Fashion (è—)</option>
                                <option value="Contact">Contact (ç²‰)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 mb-1 block">åœ–ç‰‡é€£çµ (é¸å¡«)</label>
                            <input id="add-shop-img" type="text" placeholder="https://..." class="add-input text-xs">
                        </div>
                         <div>
                            <label class="text-xs font-bold text-gray-500 mb-1 block">å‚™è¨» (é¸å¡«)</label>
                            <input id="add-shop-note" type="text" placeholder="å‹è™Ÿ/è‰²è™Ÿ" class="add-input">
                        </div>
                        <button onclick="addNewShopItem()" class="w-full bg-jp-gold text-white py-3 rounded-lg hover:bg-yellow-600 transition font-bold mt-2 shadow-sm">ï¼‹ åŠ å…¥è³¼ç‰©æ¸…å–® (é›²ç«¯)</button>
                    </div>
                </div>

                <!-- 3. æ–°å¢è¡Œæ Form -->
                <div id="form-luggage" class="add-form-group border-l-4 border-l-gray-400">
                    <div class="space-y-3">
                         <div>
                            <label class="text-xs font-bold text-jp-brown mb-1 block">ç‰©å“åç¨±</label>
                            <input id="new-item-input-add" type="text" placeholder="ä¾‹å¦‚ï¼šå¤ªé™½çœ¼é¡" class="add-input">
                        </div>
                        <div class="flex gap-2">
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-jp-brown mb-1 block">åˆ†é¡</label>
                                <select id="new-item-category-add" class="add-input bg-white h-10">
                                    <option value="é›œç‰©">é›œç‰©</option>
                                    <option value="3C">3C</option>
                                    <option value="è¡£ç‰©">è¡£ç‰©</option>
                                    <option value="åŒ–å¦ã€ä¿é¤Š">ä¿é¤Š</option>
                                    <option value="é‡è¦">é‡è¦</option>
                                </select>
                            </div>
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-jp-brown mb-1 block">ä½ç½®</label>
                                <select id="new-item-location-add" class="add-input bg-white h-10">
                                    <option value="å¤§ç®±">å¤§ç®±</option>
                                    <option value="ç™»æ©Ÿç®±">ç™»æ©Ÿç®±</option>
                                    <option value="éš¨èº«åŒ…">éš¨èº«</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 mb-1 block">å‚™è¨» (é¸å¡«)</label>
                            <input id="new-item-note-add" type="text" placeholder="å‚™è¨»" class="add-input">
                        </div>
                        <button onclick="addItemFromTab()" class="w-full bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition font-bold mt-2 shadow-sm">ï¼‹ åŠ å…¥è¡Œææ¸…å–® (æœ¬æ©Ÿ)</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="transport" class="content-section bg-white p-4 md:p-8 rounded-2xl shadow-lg border border-jp-gold/20">
            <!-- (åŸäº¤é€šä½å®¿å…§å®¹ä¿æŒä¸è®Š) -->
            <h2 class="text-xl font-bold text-jp-brown mb-4 md:mb-8 flex items-center justify-center"><span class="text-jp-gold mr-3">âœ¦</span> äº¤é€šèˆ‡ä½å®¿ <span class="text-jp-gold ml-3">âœ¦</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                <div class="space-y-4">
                    <h3 class="text-lg font-bold text-jp-brown border-l-4 border-jp-gold pl-2">ä½å®¿åœ°é»</h3>
                    <div class="bg-jp-gold-light/20 p-4 rounded-lg border border-jp-gold/30 hover:shadow-md transition">
                        <h4 class="font-bold text-base mb-1 text-jp-brown">ç®±æ ¹ï¼šHakone Pax Yoshino</h4>
                        <div class="text-sm space-y-1 opacity-90"><p>ğŸ“… å…¥ä½ï¼š12/5 (é€±äº”)</p><p>ğŸ’° è²»ç”¨ï¼šNT$5,933</p><p class="text-jp-gold font-medium mt-1">â™¨ï¸ å«æº«æ³‰è¨­æ–½ï¼Œè¿‘ç®±æ ¹æ¹¯æœ¬ç«™ã€‚</p></div>
                        <div class="mt-3 flex gap-2">
                            <a href="https://www.google.com/maps/search/?api=1&query=Hakone+Pax+Yoshino" target="_blank" class="flex-1 bg-white border border-jp-gold text-jp-gold text-center py-1.5 rounded text-sm font-bold hover:bg-jp-gold hover:text-white transition">ğŸ“ å°èˆª</a>
                            <a href="https://drive.google.com/file/d/1kFCqkIJQaeTwhye7JWpecG2g66Il7S7n/view?usp=drive_link" target="_blank" class="flex-1 bg-jp-gold text-white text-center py-1.5 rounded text-sm font-bold hover:bg-yellow-600 transition">ğŸ“„ å…¥ä½æ†‘è­‰</a>
                        </div>
                    </div>
                    <div class="bg-jp-gold-light/20 p-4 rounded-lg border border-jp-red/30 hover:shadow-md transition relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-jp-red text-white text-xs px-2 py-1 rounded-bl">é‡è¦</div>
                        <h4 class="font-bold text-base mb-1 text-jp-brown">æ±äº¬ï¼šç§‹è‘‰è‹‘</h4>
                        <div class="text-sm space-y-1 opacity-90"><p>ğŸ“… å…¥ä½ï¼š12/6 - 12/8 (ä¸‰æ™š)</p><p>ğŸ“ åœ°å€ï¼šåƒä»£ç”°åŒºå¤–ç¥ç”°ä¸‰ä¸ç›®8-8</p><p>ğŸ“ é›»è©±ï¼š070-8333-3174</p></div>
                        <div class="mt-3 grid grid-cols-2 gap-2">
                            <a href="https://www.google.com/maps/search/?api=1&query=åƒä»£ç”°åŒºå¤–ç¥ç”°ä¸‰ä¸ç›®8-8" target="_blank" class="bg-white border border-gray-400 text-gray-700 text-center py-1.5 rounded text-sm font-bold hover:bg-gray-100 transition">ğŸ“ å°èˆª</a>
                            <a href="https://fl-hotel.jp/wp-content/uploads/RAK-Self-Check-in-Instruction.pdf" target="_blank" class="bg-blue-600 text-white text-center py-1.5 rounded text-sm font-bold hover:bg-blue-700 transition">ğŸ“˜ å…¥ä½æŒ‡å—</a>
                            <button onclick="openAccommodationModal()" class="col-span-2 border border-jp-red text-jp-red hover:bg-jp-red hover:text-white font-bold py-1.5 rounded transition duration-300 text-sm flex items-center justify-center"><span class="mr-2">âš ï¸</span> æŸ¥çœ‹è©³ç´°å…¥ä½é ˆçŸ¥</button>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <h3 class="text-lg font-bold text-jp-brown border-l-4 border-jp-gold pl-2">èˆªç­è³‡è¨Š</h3>
                    <div onclick="openFlightModal()" class="cursor-pointer group bg-white p-4 rounded-lg border border-jp-gold/30 shadow-sm hover:shadow-md hover:border-jp-gold transition-all duration-300 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-jp-gold text-white text-xs px-2 py-1 rounded-bl-lg font-bold">é»æ“ŠæŸ¥çœ‹è©³æƒ…</div>
                        <div class="flex flex-col gap-3">
                            <div class="flex items-center gap-3"><div class="bg-jp-gold/10 p-2 rounded-full text-xl">âœˆï¸</div><div><h4 class="text-base font-bold text-jp-brown">å°åŒ— â‡Œ æ±äº¬</h4><p class="text-xs text-gray-500">2025/12/5 - 12/9</p></div></div>
                            <div class="flex gap-2 text-xs text-gray-600"><span class="bg-gray-100 px-2 py-1 rounded flex items-center gap-1"><span class="text-jp-red font-bold">å»</span> GK012</span><span class="bg-gray-100 px-2 py-1 rounded flex items-center gap-1"><span class="text-jp-brown font-bold">å›</span> TR875</span></div>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-jp-brown border-l-4 border-jp-gold pl-2">äº¤é€šç¥¨åˆ¸</h3>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm leading-relaxed">
                        <ul class="space-y-3 list-none ml-0 text-jp-brown text-sm">
                            <li class="pl-2 border-l-2 border-jp-gold"><span class="font-bold block">N'EX æˆç”°ç‰¹å¿«</span><span class="text-xs text-gray-600">Klookè¨‚ç¥¨é¸ä½ â†’ QR Code åˆ°æ©Ÿå ´è»Šç«™å…§çš„<span class="text-blue-600 font-bold">æ·ºè—è‰²æŒ‡å®šå¸­å”®ç¥¨æ©Ÿ</span>æ›ç¥¨ã€‚</span></li>
                            <li class="pl-2 border-l-2 border-jp-gold"><span class="font-bold block">ç®±æ ¹å‘¨éŠåˆ¸ + æµªæ¼«ç‰¹å¿«</span><span class="text-xs text-gray-600">å‡ºç¤º EMOT è»Šç¥¨åŠè³¼è²·æ†‘è­‰ã€‚</span></li>
                            <li class="pl-2 border-l-2 border-jp-gold"><span class="font-bold block">Subway Ticket (3æ—¥)</span><span class="text-xs text-gray-600">Klookè³¼è²· â†’ ç¬¬äºŒå¤©è‡³ç§‹è‘‰åŸæ™‚å°‹æ‰¾<span class="text-red-500 font-bold">ç´…è‰²åœ“æ¨™ç¤ºç¥¨æ©Ÿ</span>æ›ç¥¨ (12/7~12/9 ä½¿ç”¨)ã€‚</span></li>
                            <li class="pl-2 border-l-2 border-jp-gold"><span class="font-bold block">è¥¿ç“œå¡ (Suica)</span><span class="text-xs text-gray-600">æ©Ÿå ´è³¼è²·ï¼Œå„²å€¼ ï¿¥3000 (è¼”åŠ©ç”¨)ã€‚</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        <section id="daily-itinerary" class="content-section bg-white rounded-2xl shadow-lg border border-jp-gold/20 overflow-hidden">
            <div class="flex flex-row h-[calc(100dvh-140px)] md:h-[650px]">
                <div class="w-14 md:w-1/4 bg-gray-50 border-r border-gray-200 flex flex-col overflow-y-auto no-scrollbar flex-shrink-0 z-10">
                    <button class="date-tab active" onclick="renderItinerary('day1', this)"><span class="day-num">12/5</span><span class="day-week">é€±äº”</span></button>
                    <button class="date-tab" onclick="renderItinerary('day2', this)"><span class="day-num">12/6</span><span class="day-week">é€±å…­</span></button>
                    <button class="date-tab" onclick="renderItinerary('day3', this)"><span class="day-num">12/7</span><span class="day-week">é€±æ—¥</span></button>
                    <button class="date-tab" onclick="renderItinerary('day4', this)"><span class="day-num">12/8</span><span class="day-week">é€±ä¸€</span></button>
                    <button class="date-tab" onclick="renderItinerary('day5', this)"><span class="day-num">12/9</span><span class="day-week">é€±äºŒ</span></button>
                </div>
                <div class="flex-1 bg-white overflow-y-auto h-full p-3 md:p-8 relative scroll-smooth"><div id="itinerary-content"></div></div>
            </div>
        </section>
        <section id="map-list" class="content-section bg-white p-4 md:p-8 rounded-2xl shadow-lg border border-jp-gold/20">
            <h2 class="text-xl font-bold text-jp-brown mb-4 flex items-center justify-center">
                <span class="text-jp-gold mr-3">âœ¦</span> æ—…ç¨‹åœ°åœ– <span class="text-jp-gold ml-3">âœ¦</span>
                <span class="text-[0.6rem] text-jp-gold border border-jp-gold px-1 rounded ml-2">é›²ç«¯åŒæ­¥</span>
            </h2>
            <!-- Fixed Layout: nowrap + overflow-x-auto -->
            <div class="flex flex-nowrap overflow-x-auto no-scrollbar justify-start sm:justify-center gap-2 mb-4 items-center px-1 pb-2">
                <button class="filter-btn active px-3 py-1 rounded border border-jp-brown text-jp-brown hover:bg-jp-brown hover:text-white transition text-xs md:text-sm font-medium whitespace-nowrap flex-shrink-0" data-filter="all">å…¨éƒ¨</button>
                <button class="filter-btn px-3 py-1 rounded border border-jp-brown text-jp-brown hover:bg-jp-brown hover:text-white transition text-xs md:text-sm font-medium whitespace-nowrap flex-shrink-0" data-filter="food">ç¾é£Ÿ</button>
                <button class="filter-btn px-3 py-1 rounded border border-jp-brown text-jp-brown hover:bg-jp-brown hover:text-white transition text-xs md:text-sm font-medium whitespace-nowrap flex-shrink-0" data-filter="shopping">è³¼ç‰©</button>
                <button class="filter-btn px-3 py-1 rounded border border-jp-brown text-jp-brown hover:bg-jp-brown hover:text-white transition text-xs md:text-sm font-medium whitespace-nowrap flex-shrink-0" data-filter="sightseeing">æ™¯é»</button>
                <div class="flex gap-1 flex-shrink-0">
                    <button class="filter-btn px-3 py-1 rounded border border-jp-brown text-jp-brown hover:bg-jp-brown hover:text-white transition text-xs md:text-sm font-medium whitespace-nowrap" data-filter="nearest">ğŸ“ æœ€è¿‘</button>
                    <button id="refresh-loc-btn" onclick="refreshLocation()" class="hidden px-2 py-1 rounded bg-gray-200 text-gray-700 text-sm hover:bg-gray-300 transition" title="åˆ·æ–°å®šä½">â†»</button>
                </div>
            </div>
            <div class="flex flex-col md:flex-row gap-4 h-[calc(100dvh-190px)] md:h-[600px]">
                <div class="w-full md:w-3/5 h-2/5 md:h-full rounded-xl overflow-hidden shadow-md border border-gray-300 relative bg-gray-100 shrink-0">
                    <iframe id="map-frame" class="w-full h-full border-0" loading="lazy" allowfullscreen src=""></iframe>
                    <div id="map-placeholder" class="absolute inset-0 flex items-center justify-center bg-gray-100 text-gray-500 text-sm p-4 text-center">è«‹é»æ“Šåœ°é»ä»¥é¡¯ç¤ºåœ°åœ–</div>
                </div>
                <div class="w-full md:w-2/5 h-3/5 md:h-full overflow-y-auto pr-1 space-y-2" id="spots-list-container"></div>
            </div>
        </section>
        <section id="shopping-list" class="content-section bg-white p-4 md:p-8 rounded-2xl shadow-lg border border-jp-gold/20">
            <h2 class="text-xl font-bold text-jp-brown mb-4 flex items-center justify-center">
                <span class="text-jp-gold mr-3">âœ¦</span> è²·è²·è²·æ¸…å–® <span class="text-jp-gold ml-3">âœ¦</span>
                <span class="text-[0.6rem] text-jp-gold border border-jp-gold px-1 rounded ml-2">é›²ç«¯åŒæ­¥</span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="shopping-list-container">
                <div class="col-span-1 md:col-span-2 text-center text-gray-400 p-8">æ­£åœ¨é€£ç·šè‡³ Firebase...</div>
            </div>
        </section>
    </main>
    
    <!-- New About Modal -->
    <div id="about-modal" class="modal">
        <div class="modal-content !max-w-sm text-center relative">
            <h3 class="text-lg md:text-xl font-bold text-jp-brown mb-2">é—œæ–¼æ­¤æ‡‰ç”¨ç¨‹å¼</h3>
            <p class="text-jp-gold font-serif text-2xl font-bold mb-2 tracking-widest">TOKYO TRIP</p>
            <p id="version-display" class="text-sm text-gray-500 mb-6 font-mono">è¼‰å…¥ä¸­...</p>
            
            <div id="update-status" class="mb-4 text-sm font-bold h-6 transition-all duration-300"></div>
            
            <div class="flex flex-col gap-3">
                 <button onclick="migrateLocalToCloud()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-bold flex items-center justify-center gap-2 shadow-sm border border-blue-700">
                    <span>ğŸ“¦</span> å¾èˆŠç‰ˆåŒ¯å…¥ (åœ°åœ–/è³¼ç‰©)
                </button>
                <div class="text-xs text-gray-400 text-left mb-2 px-1">
                    *åœ°åœ–èˆ‡è³¼ç‰©æ¸…å–®ç‚ºé›²ç«¯å…±ç”¨ï¼Œè¡Œææ¸…å–®å‰‡ä¿ç•™åœ¨æ‚¨çš„æ‰‹æ©Ÿä¸­ã€‚
                </div>
                <button onclick="checkForUpdates()" class="w-full bg-jp-brown text-white py-3 rounded-lg hover:bg-gray-700 transition font-bold flex items-center justify-center gap-2 shadow-sm">
                    <span>ğŸ”„</span> æª¢æŸ¥é€£ç·šç‹€æ…‹
                </button>
                <button onclick="closeAboutModal()" class="w-full bg-gray-100 text-gray-600 py-3 rounded-lg hover:bg-gray-200 transition font-bold">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="edit-modal" class="modal"><div class="modal-content"><h3 class="text-lg font-bold mb-4 text-jp-brown">ç·¨è¼¯è¡Œæç‰©å“</h3><div class="space-y-3"><input id="edit-item-name" class="w-full p-2 border rounded text-sm" placeholder="åç¨±"><div class="flex gap-2"><select id="edit-item-category" class="w-1/2 p-2 border rounded text-sm bg-white"></select><select id="edit-item-location" class="w-1/2 p-2 border rounded text-sm bg-white"></select></div><input id="edit-item-note" class="w-full p-2 border rounded text-sm" placeholder="å‚™è¨»"><div class="flex justify-end gap-2 mt-4"><button onclick="closeModal()" class="px-3 py-1.5 text-sm bg-gray-200 rounded">å–æ¶ˆ</button><button onclick="saveEdit()" class="px-3 py-1.5 text-sm bg-jp-gold text-white rounded">å„²å­˜</button></div></div></div></div>
    <div id="delete-modal" class="modal"><div class="modal-content !max-w-sm text-center"><h3 class="text-lg font-bold mb-4 text-jp-brown">ç¢ºå®šåˆªé™¤æ­¤ç‰©å“ï¼Ÿ</h3><div class="flex justify-center gap-4"><button onclick="closeDeleteModal()" class="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300">å–æ¶ˆ</button><button onclick="confirmDelete()" class="px-3 py-1.5 text-sm bg-jp-red text-white rounded hover:bg-red-700">ç¢ºå®šåˆªé™¤</button></div></div></div>
    
    <!-- New: Shop Edit Modal -->
    <div id="shop-edit-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 text-jp-brown">ç·¨è¼¯è³¼ç‰©é …ç›®</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500">åç¨±</label>
                    <input id="shop-edit-name" class="w-full p-2 border rounded text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-500">åˆ†é¡</label>
                    <select id="shop-edit-category" class="w-full p-2 border rounded text-sm bg-white">
                        <option value="è—¥å¦ä¿é¤Š">è—¥å¦ä¿é¤Š</option>
                        <option value="ç”Ÿæ´»é›œè²¨/é›»å™¨">ç”Ÿæ´»é›œè²¨/é›»å™¨</option>
                        <option value="æœé£¾é…ä»¶">æœé£¾é…ä»¶</option>
                        <option value="é›¶é£Ÿä¼´æ‰‹ç¦®">é›¶é£Ÿä¼´æ‰‹ç¦®</option>
                        <!-- å·²ç§»é™¤ç¾ç³éš±çœ¼ -->
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-500">è³¼è²·åœ°é»</label>
                    <input id="shop-edit-location" class="w-full p-2 border rounded text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-500">åœ–ç‰‡é€£çµ</label>
                    <input id="shop-edit-img" class="w-full p-2 border rounded text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-500">å‚™è¨»</label>
                    <input id="shop-edit-note" class="w-full p-2 border rounded text-sm">
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="closeShopEditModal()" class="px-3 py-1.5 text-sm bg-gray-200 rounded">å–æ¶ˆ</button>
                    <button onclick="saveShopEdit()" class="px-3 py-1.5 text-sm bg-jp-gold text-white rounded">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New: Shop Delete Modal -->
    <div id="shop-delete-modal" class="modal">
        <div class="modal-content !max-w-sm text-center">
            <h3 class="text-lg font-bold mb-4 text-jp-brown">ç¢ºå®šåˆªé™¤æ­¤è³¼ç‰©é …ç›®ï¼Ÿ</h3>
            <div class="flex justify-center gap-4">
                <button onclick="closeShopDeleteModal()" class="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300">å–æ¶ˆ</button>
                <button onclick="confirmShopDelete()" class="px-3 py-1.5 text-sm bg-jp-red text-white rounded hover:bg-red-700">ç¢ºå®šåˆªé™¤</button>
            </div>
        </div>
    </div>

    <div id="flight-modal" class="modal"><div class="modal-content !max-w-2xl"><div class="flex justify-between items-center mb-4 border-b border-jp-gold/20 pb-2"><div><h3 class="text-lg font-bold text-jp-brown">èˆªç­è©³ç´°è³‡è¨Š</h3></div><button onclick="closeFlightModal()" class="text-gray-400 hover:text-gray-600 text-xl">Ã—</button></div><div class="space-y-4 overflow-y-auto max-h-[60vh] pr-2"><div class="bg-gray-50 rounded-lg p-3 border border-gray-200"><div class="flex justify-between items-center mb-2"><span class="bg-jp-red text-white text-xs px-2 py-1 rounded font-bold">å»ç¨‹</span><span class="text-sm font-bold text-jp-brown">GK012</span></div><div class="flex justify-between items-center mb-2 text-center"><div><div class="text-xl font-bold text-jp-brown font-serif">02:30</div><div class="text-xs text-gray-500">TPE T1</div></div><div class="text-gray-300 text-xs">â”€â”€âœˆâ”€â”€</div><div><div class="text-xl font-bold text-jp-brown font-serif">06:35</div><div class="text-xs text-gray-500">NRT T3</div></div></div></div><div class="bg-gray-50 rounded-lg p-3 border border-gray-200"><div class="flex justify-between items-center mb-2"><span class="bg-jp-brown text-white text-xs px-2 py-1 rounded font-bold">å›ç¨‹</span><span class="text-sm font-bold text-jp-brown">TR875</span></div><div class="flex justify-between items-center mb-2 text-center"><div><div class="text-xl font-bold text-jp-brown font-serif">19:55</div><div class="text-xs text-gray-500">NRT T1</div></div><div class="text-gray-300 text-xs">â”€â”€âœˆâ”€â”€</div><div><div class="text-xl font-bold text-jp-brown font-serif">23:10</div><div class="text-xs text-gray-500">TPE T1</div></div></div></div></div><div class="mt-4 flex flex-col gap-2"><a href="https://drive.google.com/file/d/1ceKVL8iBFr5vEEehSfgJVRKazmoc6PPP/view?usp=sharing" target="_blank" class="block w-full bg-blue-600 text-white text-center py-2 rounded hover:bg-blue-700 transition font-bold">ğŸ“„ æŸ¥çœ‹é›»å­è¡Œç¨‹å–®</a><button onclick="closeFlightModal()" class="w-full mt-2 bg-jp-brown text-white py-2 rounded hover:bg-gray-700 transition">é—œé–‰</button></div></div></div>
    <div id="accommodation-modal" class="modal"><div class="modal-content border-t-4 border-jp-red"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-jp-brown">ç§‹è‘‰è‹‘ - å…¥ä½é ˆçŸ¥</h3><button onclick="closeAccommodationModal()" class="text-gray-400 hover:text-gray-600">âœ•</button></div><div class="bg-red-50 p-3 rounded border border-red-100 mb-3 space-y-2"><p class="font-bold text-jp-red text-base">âš ï¸ åš´é‡è­¦å‘Š & è¦å®š</p><ul class="list-decimal list-inside text-xs text-red-800 space-y-1 font-bold"><li>å±‹å…§åš´ç¦å¸è¸ã€‚</li><li>åƒä»£ç”°å€åƒåœ¾è¦å®šæ¥µåš´æ ¼ï¼Œè«‹å‹™å¿…éµç…§æŒ‡å—ä¸Ÿæ£„ï¼Œé•è€…è‡ªè² æ³•å¾‹è²¬ä»»ã€‚</li><li>è«‹åœ¨åˆ°é”å‰ 1 å°æ™‚é€šçŸ¥ã€‚</li><li>è‹¥éœ€æ™šä¸Š 7 é»å¾Œå…¥ä½ï¼Œè«‹æå‰é ç´„ã€‚</li></ul></div><div class="space-y-3 text-sm text-gray-700 border-t pt-3 border-gray-100"><div><p class="font-bold text-jp-brown">ğŸ•’ å…¥ä½æ™‚é–“</p><p>16:00 ä»¥å¾Œ (å…¥ä½å¾Œè«‹å‚³è¨Šæ¯å‘ŠçŸ¥)</p></div><div><p class="font-bold text-jp-brown">ğŸ§³ è¡Œæå¯„å­˜</p><p>å…¥ä½æ—¥ 10:00 å¾Œå¯æ”¾å…¥æˆ¿å…§ã€‚</p><p class="text-xs text-gray-500">*è«‹å‚³æ”¾å¥½å¾Œçš„ç…§ç‰‡ï¼Œä¸¦æ³¨æ„å‹¿å¸¶èµ°é‘°åŒ™ã€‚</p></div><div><p class="font-bold text-jp-brown">ğŸ”‘ é€€æˆ¿æ™‚é–“</p><p>10:00 ä»¥å‰ (é‘°åŒ™æ”¾å›é‘°åŒ™ç›’)</p><p class="text-xs text-red-500 font-bold mt-1">*ç„¡å»¶é²é€€æˆ¿æœå‹™ï¼Œé•è€…æ¯å°æ™‚ç½°æ¬¾ 5000 æ—¥åœ“ã€‚</p></div></div><button onclick="closeAccommodationModal()" class="w-full mt-4 bg-jp-brown text-white py-2 rounded hover:bg-gray-700 transition">æˆ‘å·²äº†è§£</button></div></div>

    <script type="module">
        // Import Firebase Functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZu3MlDIHfc0ovQYA2U3LlqX8p4FWVQHw",
            authDomain: "tokyotrip2025-235c4.firebaseapp.com",
            projectId: "tokyotrip2025-235c4",
            storageBucket: "tokyotrip2025-235c4.firebasestorage.app",
            messagingSenderId: "33504330862",
            appId: "1:33504330862:web:6d0156c62d694522ee127f",
            measurementId: "G-V8346MDQEL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // Constants
        const TRIP_DOC_ID = "tokyo_trip_shared"; 
        const APP_VERSION = "v4.7.3";
        const docRef = doc(db, "itineraries", TRIP_DOC_ID);
        const STORAGE_KEY_LUGGAGE = "tokyo_trip_luggage_local";

        // Default Data (Used if DB is empty)
        const defaultLuggageItems = [{id:1,category:"3C",location:"å¤§ç®±",item:"å……é›»é ­+ç·š*2",note:"",checked:false},{id:2,category:"åŒ–å¦ã€ä¿é¤Š",location:"å¤§ç®±",item:"åŒ–å¦åŒ…",note:"",checked:false},{id:3,category:"åŒ–å¦ã€ä¿é¤Š",location:"å¤§ç®±",item:"ä¿é¤Šå“",note:"é›…æ¼¾ã€æ´—é¢ä¹³ã€ä¹³æ¶²ã€å¸å¦ã€éš±çœ¼",checked:false},{id:4,category:"åŒ–å¦ã€ä¿é¤Š",location:"å¤§ç®±",item:"é›»æ£’",note:"",checked:false},{id:5,category:"è¡£ç‰©",location:"å¤§ç®±",item:"é´å­",note:"",checked:false},{id:6,category:"è¡£ç‰©",location:"å¤§ç®±",item:"å¸½å­",note:"",checked:false},{id:7,category:"è¡£ç‰©",location:"å¤§ç®±",item:"å›ºå®šé«®å¤¾",note:"",checked:false},{id:8,category:"è¡£ç‰©",location:"å¤§ç®±",item:"è¤²è¥ª",note:"",checked:false},{id:9,category:"è¡£ç‰©",location:"å¤§ç®±",item:"ç¡è¡£",note:"",checked:false},{id:10,category:"é›œç‰©",location:"å¤§ç®±",item:"è­·æ‰‹éœœ",note:"",checked:false},{id:11,category:"åŒ–å¦ã€ä¿é¤Š",location:"ç™»æ©Ÿç®±",item:"é¡å­",note:"",checked:false},{id:12,category:"åŒ–å¦ã€ä¿é¤Š",location:"ç™»æ©Ÿç®±",item:"é¦™æ°´",note:"",checked:false},{id:13,category:"åŒ–å¦ã€ä¿é¤Š",location:"ç™»æ©Ÿç®±",item:"å°åŒ–å¦åŒ…",note:"è£œå¦ç”¨",checked:false},{id:14,category:"è¡£ç‰©",location:"ç™»æ©Ÿç®±",item:"åšå¤–å¥—",note:"",checked:false},{id:15,category:"é›œç‰©",location:"ç™»æ©Ÿç®±",item:"è—¥å“",note:"",checked:false},{id:16,category:"é›œç‰©",location:"ç™»æ©Ÿç®±",item:"ç‰™åˆ·",note:"",checked:false},{id:17,category:"é›œç‰©",location:"ç™»æ©Ÿç®±",item:"æš–æš–åŒ…",note:"",checked:false},{id:18,category:"é›œç‰©",location:"ç™»æ©Ÿç®±",item:"è¡Œæç§¤",note:"",checked:false},{id:19,category:"3C",location:"éš¨èº«åŒ…",item:"è€³æ©Ÿ",note:"",checked:false},{id:20,category:"3C",location:"éš¨èº«åŒ…",item:"è¡Œå‹•é›»æº",note:"",checked:false},{id:21,category:"3C",location:"éš¨èº«åŒ…",item:"ç¶²å¡",note:"",checked:false},{id:22,category:"3C",location:"éš¨èº«åŒ…",item:"è‡ªæ‹æ£’",note:"",checked:false},{id:23,category:"åŒ–å¦ã€ä¿é¤Š",location:"éš¨èº«åŒ…",item:"è­·å”‡è†",note:"",checked:false},{id:24,category:"åŒ–å¦ã€ä¿é¤Š",location:"éš¨èº«åŒ…",item:"æ¢³å­",note:"",checked:false},{id:25,category:"é‡è¦",location:"éš¨èº«åŒ…",item:"è­·ç…§",note:"",checked:false},{id:26,category:"é‡è¦",location:"éš¨èº«åŒ…",item:"æ—¥å¹£",note:"",checked:false},{id:27,category:"é‡è¦",location:"éš¨èº«åŒ…",item:"ææ¬¾å¡",note:"",checked:false},{id:28,category:"é›œç‰©",location:"éš¨èº«åŒ…",item:"è¡›ç”Ÿç´™",note:"",checked:false},{id:29,category:"é›œç‰©",location:"éš¨èº«åŒ…",item:"æ¿•ç´™å·¾",note:"",checked:false},{id:30,category:"é›œç‰©",location:"å¤§ç®±",item:"æŒ‡ç”²å‰ª",note:"",checked:false}];
        
        // å·²ä¿®æ”¹ï¼šåœ°åœ–è³‡æ–™å·²ç”±é›²ç«¯åŒæ­¥ï¼Œç§»é™¤ç¨‹å¼ç¢¼ä¸­çš„é è¨­è³‡æ–™ä»¥ç¯€çœç©ºé–“
        const defaultSpotsData = [];

        // å·²ä¿®æ”¹ï¼šè³¼ç‰©è³‡æ–™å·²ç”±é›²ç«¯åŒæ­¥ï¼Œç§»é™¤ç¨‹å¼ç¢¼ä¸­çš„é è¨­è³‡æ–™ä»¥ç¯€çœç©ºé–“
        const defaultShoppingList = [];

        const itineraryDetails = {
            day1: [
                { time: "06:35", title: "æŠµé”æˆç”°æ©Ÿå ´ T3", desc: "å…¥å¢ƒã€‚", recommended: false },
                { time: "08:13", title: "N'EX æˆç”°ç‰¹å¿«", desc: "å¾€æ–°å®¿ (09:47 æŠµ)ã€‚", recommended: false },
                { time: "10:00", title: "å°ç”°æ€¥æµªæ¼«ç‰¹å¿«", desc: "å¾€ç®±æ ¹æ¹¯æœ¬ (11:27 æŠµ)ã€‚", recommended: false },
                { 
                    time: "12:15", title: "åˆé¤ï¼šé¯›ã”ã¯ã‚“æ‡çŸ³ ç“”ç", desc: "â˜… å·²è¨‚ä½ 12:15ã€‚", recommended: false,
                    diningOptions: [
                        { name: "ã¯ã¤èŠ±ãã° æœ¬åº—", note: "è‡ªç„¶è–¯è•éº¥éºµ", rating: "3.58", price: "ï¿¥1,200~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Hatsuhana+Soba+Hakone", inMap: false },
                        { name: "æ¹¯è‘‰ä¸¼ ç›´å‰", note: "æ¹¯è‘‰ä¸¼", rating: "3.49", price: "ï¿¥1,500~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Yubadon+Naokichi", inMap: false }
                    ]
                },
                { time: "13:00", title: "ç®±æ ¹ç¶“å…¸ç’°éŠ", desc: "ç™»å±±é›»è»Š/çºœè»Š/å¤§æ¹§è°·ã€‚", recommended: false },
                { 
                    time: "15:50", 
                    title: "ç®±æ ¹æµ·è³Šèˆ¹", 
                    desc: "æ¡ƒæºå°â†’å…ƒç®±æ ¹æ¸¯ã€‚æ‹é³¥å±…ã€‚<br><a href='https://lh7-rt.googleusercontent.com/sheetsz/AHOq17Eucey5rRxE3BEuCZudnp3DQ8k7XcrftSCrz91_LSKdUAI0rcg7CFmYxLL1nLpk7RjIGb1zfDkGEynN932re-uKBTawm69gbtSJle0L-Ai_S7sbvcIpRrJBUdTeMZHkaR57IPsht8sl9517tDnmP3pEd6D1?key=GIdYLBhCljRantezzAd-jA' target='_blank' class='text-blue-500 hover:underline font-bold inline-flex items-center mt-1'>ğŸš¢ æ™‚åˆ»è¡¨</a>", 
                    recommended: false 
                },
                { 
                    time: "18:00", title: "æ™šé¤ï¼šç®±æ ¹ç•¶åœ°æ–™ç†", desc: "è»Šç«™é™„è¿‘æˆ–é£¯åº—è‡ªåŠ©é¤ã€‚", recommended: false,
                    diningOptions: [
                         { name: "çŸ¥å®¢èŒ¶å®¶", note: "è±†è…/å±±è—¥", rating: "3.51", price: "ï¿¥2,000~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Shikajaya+Hakone", inMap: false },
                         { name: "å–œä¹‹åŠ©", note: "é®®é­šå±…é…’å±‹", rating: "3.49", price: "ï¿¥3,000~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kinosuke+Hakone", inMap: false }
                    ]
                },
                { time: "20:00", title: "æº«æ³‰ & ä¼‘æ¯", desc: "å…¥ä½ Hakone Pax Yoshinoã€‚", recommended: false }
            ],
            day2: [
                { 
                    time: "09:30", title: "å‰å¾€æ©«é ˆè³€", 
                    desc: "JR (11:04 æŠµ)ã€‚<br><a href='https://world.jorudan.co.jp/mln/zh-tw/?p=50&from=%e7%ae%b1%e6%a0%b9%e6%b9%af%e6%9c%ac&to=%e6%a9%ab%e9%a0%88%e8%b3%80&date=2025%2f12%2f06&time=09%3a35&ft=0&ic=0&ut=0&up=0&us=0&nzm=0&sub_lang=ja&route=1' target='_blank' class='text-blue-500 hover:underline font-bold mt-1 inline-block'>ğŸ”— æŸ¥çœ‹ä¹˜è»Šè·¯ç·š (Jorudan)</a>", 
                    recommended: false 
                },
                { time: "12:00", title: "è»æ¸¯å·¡èˆª", desc: "â˜… é ç´„ 12:00 èˆ¹ç­ã€‚", recommended: false },
                { 
                    time: "13:00", title: "åˆé¤ï¼šHONEY BEE", desc: "ç¾è»æ¼¢å ¡ã€‚", recommended: false,
                    diningOptions: [
                        { name: "Tsunami", note: "æµ·è»å’–å“©/æ¼¢å ¡", rating: "3.49", price: "ï¿¥1,500~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Tsunami+Yokosuka", inMap: true },
                        { name: "Wood Island Curry", note: "æ©«é ˆè³€å’–å“©", rating: "3.48", price: "ï¿¥1,500~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Wood+Island+Yokosuka", inMap: true }
                    ]
                },
                { 
                    time: "15:45", title: "å‰å¾€æ±äº¬æ°‘å®¿", 
                    desc: "ç§‹è‘‰åŸ/æœ«å»£ç”ºã€‚17:30 Check-inã€‚<br><a href='https://world.jorudan.co.jp/mln/zh-tw/?p=50&from=%e6%a9%ab%e9%a0%88%e8%b3%80&to=%e7%a7%8b%e8%91%89%e5%8e%9f&date=2025%2f12%2f06&time=15%3a00&ft=0&ic=0&ut=0&up=0&us=0&nzm=0&sub_lang=ja&route=6' target='_blank' class='text-blue-500 hover:underline font-bold mt-1 inline-block'>ğŸ”— æŸ¥çœ‹ä¹˜è»Šè·¯ç·š (Jorudan)</a>", 
                    recommended: false 
                },
                { 
                    time: "18:30", title: "æ™šé¤ï¼štonkatsu.jp Omotesando", desc: "é ‚ç´šç‚¸è±¬æ’ (éœ€é ç´„)ã€‚", recommended: true, recText: "æ¨è–¦",
                    diningOptions: [
                        { name: "tonkatsu.jp", note: "é ‚ç´šç‚¸è±¬æ’", rating: "4.20", price: "ï¿¥3,500~", mapUrl: "https://www.google.com/maps/search/?api=1&query=tonkatsu.jp+Omotesando", inMap: false },
                        { name: "éŠ€åº§ ç¯", note: "é›ç™½æ¹¯æ‹‰éºµ", rating: "3.58", price: "ï¿¥1,200~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Ginza+Kagari+Roppongi", inMap: false }
                    ]
                },
                { time: "20:30", title: "è³¼ç‰©ï¼šGinza Karen", desc: "äººå½¢ç”ºè²·è¡Œæç®±ã€‚", recommended: false }
            ],
            day3: [
                { time: "09:00", title: "çš‡å±… (äºŒé‡æ©‹)", desc: "äºŒé‡æ©‹å‰ç«™ã€‚", recommended: false },
                { time: "10:30", title: "èµ¤å‚é›¢å®®", desc: "åƒè§€æœ¬é¤¨/åº­åœ’ã€‚", recommended: false },
                { 
                    time: "12:30", title: "åˆé¤ & éŠ€æä¸¦æœ¨", desc: "æ˜æ²»ç¥å®®å¤–è‹‘éŠ€æç¥­ã€‚", recommended: true, recText: "æ¨è–¦ï¼šShake Shack",
                    diningOptions: [
                        { name: "Cafe La Boheme", note: "ã€Šä½ çš„åå­—ã€‹é¤å»³", rating: "3.45", price: "ï¿¥1,500~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Cafe+La+Boheme+Shinjyuku+gyoen", inMap: true },
                        { name: "ã¾ã„æ³‰ é’å±±", note: "ç‚¸è±¬æ’", rating: "3.58", price: "ï¿¥1,800~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Tonkatsu+Maisen+Aoyama", inMap: false }
                    ]
                },
                { time: "14:30", title: "åŸå®¿ / è¡¨åƒé“", desc: "KITH, BEAMS, Human Madeã€‚", recommended: false },
                { 
                    time: "16:00", 
                    title: "SHIBUYA SKY", 
                    desc: "â˜… å·²è³¼è²· 16:00 æ—¥è½å ´æ¬¡ã€‚<br><div class='mt-2 flex gap-2'><a href='https://photos.app.goo.gl/BNrc7svR37C6QN377' target='_blank' class='flex-1 bg-blue-600 text-white text-center py-2 rounded text-sm font-bold hover:bg-blue-700 transition shadow-sm'>ğŸ« ç¥¨åˆ¸ 1/2</a><a href='https://photos.app.goo.gl/JQfPEXTPoXSKNF4k7' target='_blank' class='flex-1 bg-blue-600 text-white text-center py-2 rounded text-sm font-bold hover:bg-blue-700 transition shadow-sm'>ğŸ« ç¥¨åˆ¸ 2/2</a></div>", 
                    recommended: false 
                },
                { time: "18:00", title: "æ¾€è°· PARCO/Donki", desc: "ä»»å¤©å ‚, è—¥å¦ã€‚", recommended: false },
                { 
                    time: "19:30", title: "æ™šé¤ï¼šç‰›ãŸã‚“ è’", desc: "åšåˆ‡ç‰›èˆŒã€‚", recommended: false,
                    diningOptions: [
                        { name: "Kenyan Shibuya", note: "ç´…èŒ¶/è¼•é£Ÿ", rating: "3.55", price: "ï¿¥1,000~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kenyan+Shibuya", inMap: true },
                        { name: "ã‹ã¤ã©ã‚“å±‹ ç‘å…†", note: "è±¬æ’ä¸¼", rating: "3.68", price: "ï¿¥1,000~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Katsudon-ya+Zuicho", inMap: false }
                    ]
                }
            ],
            day4: [
                { time: "09:00", title: "æ·ºè‰å’Œæœ", desc: "æ·ºè‰èŠ±ç­ã€‚", recommended: false },
                { time: "10:30", title: "æ·ºè‰å¯º / é›·é–€", desc: "æ‹ç…§é»ï¼šæ·ºè‰å¯ºæ­£é¢éšæ¢¯ä¸Šå»å¾Œå…©æ—çš„ç©ºé–“ï¼Œäººå°‘ä¹Ÿå¯ä»¥æ‹åˆ°æ·ºè‰å¯º/é›·é–€é¦¬è·¯å°é¢/ä»Šæˆ¶ç¥ç¤¾ã€å¾…ä¹³å±±è–å¤©(ç¨é èµ°è·¯20åˆ†)ã€‚", recommended: false },
                { 
                    time: "12:30", title: "åˆé¤ï¼šæ·ºè‰ç¾é£Ÿ", desc: "å’Œç‰› / åœŸé‹é£¯ / å£½å¸ã€‚", recommended: false,
                    diningOptions: [
                        { name: "é°»ç¦…", note: "é°»é­šé£¯", rating: "3.80", price: "ï¿¥4,500~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Unazen+Asakusa", inMap: true },
                        { name: "æ°´å–œ Mizuki", note: "åœŸé‹é£¯", rating: "3.45", price: "ï¿¥2,500~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Mizuki+Asakusa", inMap: true }
                    ]
                },
                { time: "14:30", title: "æ°´ä¸Šå·´å£«", desc: "â˜… é ç´„ï¼šæ·ºè‰ â†’ æµœé›¢å®®ã€‚", recommended: false },
                { time: "15:30", title: "æ±äº¬éµå¡”", desc: "æ‹ç…§é»ï¼šåƒè»€å­è‚²åœ°è—å°Šæ­¥é“ã€è±†è…å±‹åœè»Šå ´ã€KALEDOTOWER METROå¾æ±ç•™-èµ¤ç¾½æ©‹ã€‚", recommended: false },
                { 
                    time: "17:30", title: "éŠ€åº§é€›è¡— & æ™šé¤", desc: "è²·å¯éº—éœ²ï¼Œåƒæ™šé¤ã€‚", recommended: true, recText: "æ¨è–¦ï¼šPATISSERIE TEN&",
                    diningOptions: [
                        { name: "éŠ€åº§ ç¯ æœ¬åº—", note: "é›ç™½æ¹¯", rating: "3.78", price: "ï¿¥1,300~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Ginza+Kagari", inMap: false },
                        { name: "èŠ±å±±ã†ã©ã‚“", note: "å¯¬çƒé¾éºµ", rating: "3.60", price: "ï¿¥1,500~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Hanayama+Udon+Ginza", inMap: false }
                    ]
                }
            ],
            day5: [
                { time: "09:00", title: "é€€æˆ¿", desc: "å¾€æ±äº¬ç«™ã€‚", recommended: false },
                { time: "10:00", title: "æ±äº¬è»Šç«™ä¸€ç•ªè¡—", desc: "å‹•æ¼«è¡—ã€ä¼´æ‰‹ç¦®ã€‚", recommended: false },
                { 
                    time: "12:30", title: "åˆé¤ï¼šæ‹‰éºµè¡—/KITTE", desc: "æ‹‰éºµæˆ–å£½å¸ã€‚", recommended: false,
                    diningOptions: [
                        { name: "å…­å˜èˆ", note: "æ²¾éºµ", rating: "3.77", price: "ï¿¥1,100~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Rokurinsha+Tokyo+Station", inMap: false },
                        { name: "ã¤ã˜åŠ", note: "æµ·é®®ç å¯¶ç›’", rating: "3.75", price: "ï¿¥1,500~", mapUrl: "https://www.google.com/maps/search/?api=1&query=Tsujihan+Nihonbashi", inMap: false }
                    ]
                },
                { time: "14:00", title: "å‰å¾€æ©Ÿå ´ T1", desc: "N'EX (15:10 æŠµ)ã€‚è¨—é‹ã€‚", recommended: false },
                { time: "15:40", title: "æŠ˜è¿”æˆç”°ç«™", desc: "å·è±Šæœ¬åº—æŠ½è™Ÿç¢¼ç‰Œåƒé°»é­šã€‚", recommended: true, recText: "æ¨è–¦ï¼šå·è±Š æœ¬åº—" },
                { time: "17:30", title: "è¿”å›æ©Ÿå ´ T1", desc: "äº¬æˆæˆç”° â†’ T1ã€‚", recommended: false },
                { time: "17:45", title: "å…ç¨…åº—", desc: "æœ€å¾Œæ¡è²·ã€‚", recommended: false },
                { time: "19:55", title: "èµ·é£›", desc: "TR875ã€‚", recommended: false }
            ]
        };

        let luggageItems = []; 
        let spotsData = []; 
        let shoppingList = [];
        let currentEditId = null; let itemToDeleteId = null;
        let globalRegistration = null;

        // New Variables for Shop Edit
        let currentShopEditId = null; 
        let currentShopDeleteId = null;
        let userLocation = { lat: null, lng: null };

        const navBtns = document.querySelectorAll('.nav-btn'); const sections = document.querySelectorAll('.content-section'); const spotsListContainer = document.getElementById('spots-list-container'); const mapFrame = document.getElementById('map-frame'); const mapPlaceholder = document.getElementById('map-placeholder'); const filterBtns = document.querySelectorAll('.filter-btn'); const shoppingContainer = document.getElementById('shopping-list-container'); const luggageContainer = document.getElementById('luggage-list-container'); const mainContent = document.getElementById('main-content');

        // --- Load Luggage Local Function ---
        function loadLuggageLocal() {
            const saved = localStorage.getItem(STORAGE_KEY_LUGGAGE);
            if (saved) {
                try {
                    luggageItems = JSON.parse(saved);
                } catch (e) {
                    console.error("Local luggage parse error", e);
                    luggageItems = defaultLuggageItems;
                }
            } else {
                luggageItems = defaultLuggageItems;
            }
            renderLuggage();
        }

        // --- Firestore Data Logic ---

        function initApp() {
            // å…ˆè¼‰å…¥æœ¬åœ°è¡Œææ¸…å–®
            loadLuggageLocal();

            // ä½¿ç”¨ onSnapshot ç›£è½å³æ™‚æ›´æ–° (åªåŒ…å«åœ°åœ–èˆ‡è³¼ç‰©)
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // æ³¨æ„ï¼šä¸å†å¾é›²ç«¯è®€å– luggageItems
                    spotsData = data.spots || [];
                    shoppingList = data.shopping || [];
                    
                    // é‡æ–°æ¸²æŸ“ç•«é¢
                    const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
                    renderSpotsList(activeFilter);
                    renderShoppingList();
                    console.log("Firebase æ•¸æ“šå·²åŒæ­¥ï¼");
                } else {
                    // è‹¥é›²ç«¯ç„¡è³‡æ–™ï¼Œå¯«å…¥é è¨­å€¼ (æ’é™¤è¡Œæ)
                    console.log("é›²ç«¯ç„¡è³‡æ–™ï¼Œæ­£åœ¨åˆå§‹åŒ–...");
                    setDoc(docRef, {
                        // luggage: defaultLuggageItems, // ä¸å†ä¸Šå‚³è¡Œæ
                        spots: defaultSpotsData,
                        shopping: defaultShoppingList
                    }).then(() => {
                        console.log("åˆå§‹åŒ–å®Œæˆï¼");
                    });
                }
            }, (error) => {
                console.error("Firebase é€£ç·šéŒ¯èª¤:", error);
                shoppingContainer.innerHTML = '<div class="text-center p-4 text-red-400">é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚</div>';
            });
        }

        // --- MIGRATION LOGIC (ä¸€éµæ¬å®¶åŠŸèƒ½) ---
        window.migrateLocalToCloud = async function() {
            // åªæ¬å®¶æ™¯é»å’Œè³¼ç‰©ï¼Œè¡Œæä¿ç•™åœ¨æœ¬åœ°
            const potentialSpotsKeys = ['spots', 'spotsData', 'tokyo_spots'];
            const potentialShopKeys = ['shopping', 'shoppingList', 'tokyo_shopping'];

            let oldSpots = null;
            let oldShopping = null;

            // å°‹æ‰¾æ™¯é»è³‡æ–™
            for (const key of potentialSpotsKeys) {
                const item = localStorage.getItem(key);
                if (item) { oldSpots = JSON.parse(item); break; }
            }
            // å°‹æ‰¾è³¼ç‰©è³‡æ–™
            for (const key of potentialShopKeys) {
                const item = localStorage.getItem(key);
                if (item) { oldShopping = JSON.parse(item); break; }
            }

            if (!oldSpots && !oldShopping) {
                alert('âš ï¸ åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­æ‰¾ä¸åˆ°èˆŠç‰ˆè³‡æ–™ã€‚\n(å¯èƒ½æ˜¯å·²ç¶“æ¸…é™¤å¿«å–ï¼Œæˆ–Keyå€¼ä¸åŒ¹é…)');
                return;
            }

            const confirmMsg = `ç™¼ç¾èˆŠç‰ˆè³‡æ–™ï¼\n\næ™¯é»é …ç›®ï¼š${oldSpots ? oldSpots.length : 0} ç­†\nè³¼ç‰©é …ç›®ï¼š${oldShopping ? oldShopping.length : 0} ç­†\n\nç¢ºå®šè¦å°‡é€™äº›è³‡æ–™ä¸Šå‚³åˆ°é›²ç«¯å—ï¼Ÿ\n(é€™å°‡æœƒè¦†è“‹ç›®å‰çš„é›²ç«¯è³‡æ–™)\n*æ³¨æ„ï¼šæ‚¨çš„è¡Œææ¸…å–®å°‡ä¿ç•™åœ¨æ‰‹æ©Ÿä¸­ï¼Œä¸æœƒä¸Šå‚³ã€‚`;
            
            if (confirm(confirmMsg)) {
                try {
                    const updateData = {};
                    if(oldSpots) updateData.spots = oldSpots;
                    if(oldShopping) updateData.shopping = oldShopping;

                    await updateDoc(docRef, updateData);
                    alert('âœ… æ¬å®¶æˆåŠŸï¼æ™¯é»èˆ‡è³¼ç‰©æ¸…å–®å·²åŒæ­¥åˆ°é›²ç«¯ã€‚');
                    closeAboutModal();
                } catch (e) {
                    console.error("Migration failed:", e);
                    alert('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + e.message);
                }
            }
        }

        // Data Savers
        // è¡Œæå­˜åˆ°æœ¬åœ° LocalStorage
        async function saveData() { 
            try {
                localStorage.setItem(STORAGE_KEY_LUGGAGE, JSON.stringify(luggageItems));
            } catch (e) { console.error("Error saving luggage locally:", e); }
        }
        // åœ°åœ–å­˜åˆ°é›²ç«¯
        async function saveSpots() { 
            try {
                await updateDoc(docRef, { spots: spotsData });
            } catch (e) { console.error("Error saving spots:", e); }
        }
        // è³¼ç‰©å­˜åˆ°é›²ç«¯
        async function saveShopping() { 
            try {
                await updateDoc(docRef, { shopping: shoppingList });
            } catch (e) { console.error("Error saving shopping:", e); }
        }

        // --- Window Exported Functions (Make accessible to HTML) ---

        window.switchAddTab = function(tabName) {
            document.querySelectorAll('.add-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.includes(tabName === 'spot' ? 'åœ°é»' : (tabName === 'shop' ? 'è³¼ç‰©' : 'è¡Œæ'))) {
                    btn.classList.add('active');
                }
            });
            document.querySelectorAll('.add-form-group').forEach(form => form.classList.remove('active'));
            document.getElementById(`form-${tabName}`).classList.add('active');
        }

        window.addItemFromTab = function() {
            const name = document.getElementById('new-item-input-add').value.trim();
            if (!name) return;
            luggageItems.push({ id: Date.now(), item: name, category: document.getElementById('new-item-category-add').value, location: document.getElementById('new-item-location-add').value, note: document.getElementById('new-item-note-add').value, checked: false });
            document.getElementById('new-item-input-add').value = ''; document.getElementById('new-item-note-add').value = '';
            alert('è¡Œæç‰©å“å·²æ–°å¢ï¼');
            saveData();
            renderLuggage(); // Need explicit render for local data
        }

        window.addNewSpot = function() {
            const name = document.getElementById('add-spot-name').value.trim();
            if (!name) { alert('è«‹è¼¸å…¥åœ°åœ–åœ°é»åç¨±'); return; }
            
            let note = document.getElementById('add-spot-note').value.trim();
            const type = document.getElementById('add-spot-type').value;

            // Auto-fill note logic
            if (!note) {
                const n = name.toLowerCase();
                if (n.includes('kenyan') || (n.includes('æ¾€è°·') && n.includes('ç´…èŒ¶'))) note = 'æ¾€è°·è€ç‰Œç´…èŒ¶åº—';
                else if (n.includes('shibuya sky') || n.includes('å±•æœ›å°')) note = 'æ¾€è°·ç†±é–€é«˜ç©ºè§€æ™¯å°';
                else {
                    switch(type) {
                        case 'food': note = "Google è©•åˆ†é«˜åˆ†ç¾é£Ÿ"; break;
                        case 'shopping': note = "ç†±é–€è³¼ç‰©å•†åœˆ"; break;
                        case 'sightseeing': note = "æ±äº¬å¿…è¨ªæ‰“å¡é»"; break;
                        default: note = "Google Maps ç†±é–€åœ°é»";
                    }
                }
            }
            
            const newSpot = {
                name: name,
                type: type,
                note: note,
                map: document.getElementById('add-spot-map').value || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`,
                externalLink: document.getElementById('add-spot-link').value,
                lat: 0, lng: 0 
            };
            
            spotsData.push(newSpot);
            saveSpots();
            alert('æ–°åœ°é»å·²åŠ å…¥åœ°åœ–åˆ—è¡¨ï¼');
            document.getElementById('add-spot-name').value = '';
            document.getElementById('add-spot-note').value = '';
            document.getElementById('add-spot-map').value = '';
            document.getElementById('add-spot-link').value = '';
        }

        window.addNewShopItem = function() {
            const name = document.getElementById('add-shop-name').value.trim();
            if (!name) { alert('è«‹è¼¸å…¥å•†å“åç¨±'); return; }

            let location = document.getElementById('add-shop-location').value.trim();
            const category = document.getElementById('add-shop-category').value;

            if (!location) {
                switch(category) {
                    case 'è—¥å¦ä¿é¤Š': location = "å„è—¥å¦åº— (æ¾æœ¬æ¸…/å¤§åœ‹)"; break;
                    case 'ç”Ÿæ´»é›œè²¨/é›»å™¨': location = "Bic Camera / Yodobashi"; break;
                    case 'æœé£¾é…ä»¶': location = "ç™¾è²¨å…¬å¸ / å•†å ´"; break;
                    case 'é›¶é£Ÿä¼´æ‰‹ç¦®': location = "æ©Ÿå ´å…ç¨…åº— / Donki"; break;
                    // ç¾ç³éš±çœ¼ case removed
                    default: location = "å¾…ç¢ºèª";
                }
            }

            const newShop = {
                id: 'shop-' + Date.now(),
                name: name,
                category: category,
                location: location,
                tag: document.getElementById('add-shop-tag').value,
                image: document.getElementById('add-shop-img').value,
                note: document.getElementById('add-shop-note').value
            };

            shoppingList.push(newShop);
            saveShopping();
            alert('æ–°å•†å“å·²åŠ å…¥è³¼ç‰©æ¸…å–®ï¼');
            document.getElementById('add-shop-name').value = '';
            document.getElementById('add-shop-location').value = '';
            document.getElementById('add-shop-img').value = '';
            document.getElementById('add-shop-note').value = '';
        }

        window.searchLocationForShop = function() {
            const locName = document.getElementById('add-shop-location').value.trim();
            if(locName) {
                window.open(`https://www.google.com/maps/search/${encodeURIComponent(locName)}`, '_blank');
            } else {
                alert('è«‹å…ˆè¼¸å…¥åœ°é»åç¨±');
            }
        }

        // --- Shop Edit/Delete Functions ---
        window.openShopEdit = function(id) {
            currentShopEditId = id;
            const item = shoppingList.find(i => i.id === id);
            if(!item) return;

            document.getElementById('shop-edit-name').value = item.name;
            
            // å¦‚æœåŸæœ¬æ˜¯ç¾ç³éš±çœ¼ï¼Œç·¨è¼¯æ™‚æœƒè‡ªå‹•é¡¯ç¤ºè—¥å¦ä¿é¤Šï¼Œå› ç‚ºä¸‹æ‹‰é¸å–®æ²’æœ‰ç¾ç³éš±çœ¼äº†
            // é€™è£¡å¯ä»¥åšä¸€å€‹é˜²å‘†ï¼Œå¦‚æœ item.category æ˜¯èˆŠçš„ "ç¾ç³éš±çœ¼"ï¼Œé é¸ "è—¥å¦ä¿é¤Š"
            let cat = item.category;
            if(cat === "ç¾ç³éš±çœ¼") cat = "è—¥å¦ä¿é¤Š";
            
            document.getElementById('shop-edit-category').value = cat;
            document.getElementById('shop-edit-location').value = item.location;
            document.getElementById('shop-edit-img').value = item.image || '';
            document.getElementById('shop-edit-note').value = item.note || '';
            document.getElementById('shop-edit-modal').style.display = 'block';
        }

        window.closeShopEditModal = function() {
            document.getElementById('shop-edit-modal').style.display = 'none';
            currentShopEditId = null;
        }

        window.saveShopEdit = function() {
            const item = shoppingList.find(i => i.id === currentShopEditId);
            if(item) {
                item.name = document.getElementById('shop-edit-name').value;
                item.category = document.getElementById('shop-edit-category').value;
                item.location = document.getElementById('shop-edit-location').value;
                item.image = document.getElementById('shop-edit-img').value;
                item.note = document.getElementById('shop-edit-note').value;
                saveShopping();
                closeShopEditModal();
            }
        }

        window.openShopDelete = function(id) {
            currentShopDeleteId = id;
            document.getElementById('shop-delete-modal').style.display = 'block';
        }

        window.closeShopDeleteModal = function() {
            document.getElementById('shop-delete-modal').style.display = 'none';
            currentShopDeleteId = null;
        }

        window.confirmShopDelete = function() {
            if(currentShopDeleteId) {
                shoppingList = shoppingList.filter(i => i.id !== currentShopDeleteId);
                saveShopping();
                closeShopDeleteModal();
            }
        }

        // --- Luggage Logic ---
        window.toggleCheck = function(id) { 
            const numId = parseInt(id); 
            const targetId = isNaN(numId) ? id : numId;

            const item = luggageItems.find(i => i.id == targetId); 
            if (item) { 
                item.checked = !item.checked; 
                saveData(); 
                renderLuggage(); // Explicit render for local
            } 
        }

        window.openEdit = function(id) {
            currentEditId = id; 
            const numId = parseInt(id);
            const targetId = isNaN(numId) ? id : numId;
            const item = luggageItems.find(i => i.id == targetId); 
            if (!item) return;

            document.getElementById('edit-item-name').value = item.item; document.getElementById('edit-item-note').value = item.note || '';
            const cats = ['é›œç‰©','3C','è¡£ç‰©','åŒ–å¦ã€ä¿é¤Š','é‡è¦']; const locs = ['å¤§ç®±','ç™»æ©Ÿç®±','éš¨èº«åŒ…'];
            document.getElementById('edit-item-category').innerHTML = cats.map(c => `<option value="${c}" ${c===item.category?'selected':''}>${c}</option>`).join('');
            document.getElementById('edit-item-location').innerHTML = locs.map(l => `<option value="${l}" ${l===item.location?'selected':''}>${l}</option>`).join('');
            document.getElementById('edit-modal').style.display = 'block';
        }

        window.saveEdit = function() {
            const numId = parseInt(currentEditId);
            const targetId = isNaN(numId) ? currentEditId : numId;
            const item = luggageItems.find(i => i.id == targetId);

            if (item) { 
                item.item = document.getElementById('edit-item-name').value; 
                item.category = document.getElementById('edit-item-category').value; 
                item.location = document.getElementById('edit-item-location').value; 
                item.note = document.getElementById('edit-item-note').value; 
                saveData(); 
                renderLuggage(); // Explicit render for local
                closeModal(); 
            }
        }

        window.openDelete = function(id) { 
            itemToDeleteId = id; 
            document.getElementById('delete-modal').style.display = 'block'; 
        }

        window.confirmDelete = function() { 
            if (itemToDeleteId !== null) { 
                const numId = parseInt(itemToDeleteId);
                const targetId = isNaN(numId) ? itemToDeleteId : numId;
                luggageItems = luggageItems.filter(i => i.id != targetId); 
                saveData(); 
                renderLuggage(); // Explicit render
                closeDeleteModal(); 
            } 
        }

        window.closeDeleteModal = function() { itemToDeleteId = null; document.getElementById('delete-modal').style.display = 'none'; }
        
        function renderLuggage() {
            if(!luggageContainer) return; luggageContainer.innerHTML = '';
            if (luggageItems.length === 0) { luggageContainer.innerHTML = '<div class="text-center text-gray-400 text-sm p-4">æ¸…å–®ç›®å‰æ˜¯ç©ºçš„ï¼Œè«‹æ–°å¢ç‰©å“ã€‚</div>'; return; }
            [...luggageItems].sort((a, b) => { if(a.location !== b.location) return a.location.localeCompare(b.location, "zh-TW"); if(a.category !== b.category) return a.category.localeCompare(b.category, "zh-TW"); return a.checked - b.checked; }).forEach(item => {
                let locColor = 'bg-gray-100 text-gray-800'; if (item.location === 'å¤§ç®±') locColor = 'bg-blue-100 text-blue-800 border border-blue-200'; else if (item.location === 'ç™»æ©Ÿç®±') locColor = 'bg-green-100 text-green-800 border border-green-200'; else if (item.location === 'éš¨èº«åŒ…') locColor = 'bg-yellow-100 text-yellow-800 border border-yellow-200';
                const badgeColor = item.category === 'é‡è¦' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600';
                luggageContainer.innerHTML += `<div class="flex items-start p-2 bg-gray-50 rounded border border-gray-100 hover:bg-white transition ${item.checked ? 'opacity-50' : ''}"><input type="checkbox" class="mt-1 mr-2 cursor-pointer" ${item.checked ? 'checked' : ''} onchange="toggleCheck('${item.id}')"><div class="flex-grow"><div class="flex gap-1 mb-1"><span class="text-xs px-1.5 rounded ${locColor}">${item.location}</span><span class="text-xs px-1.5 rounded ${badgeColor}">${item.category}</span></div><div class="font-medium text-sm text-jp-brown ${item.checked ? 'line-through' : ''}">${item.item}</div>${item.note ? `<div class="text-xs text-gray-500 mt-0.5">ğŸ“ ${item.note}</div>` : ''}</div><button onclick="openEdit('${item.id}')" class="text-blue-400 hover:text-blue-600 mx-1">âœï¸</button><button onclick="openDelete('${item.id}')" class="text-red-400 hover:text-red-600 mx-1">ğŸ—‘ï¸</button></div>`;
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; 
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        function formatDistance(distKm) {
            if (distKm < 1) {
                return Math.round(distKm * 1000) + "m";
            }
            return distKm.toFixed(1) + "km";
        }

        window.refreshLocation = function() {
            if (navigator.geolocation) {
                const btn = document.getElementById('refresh-loc-btn');
                const originalText = btn.innerText; 
                btn.innerText = "â³";
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        btn.innerText = "â†»"; 
                        const activeFilterBtn = document.querySelector('.filter-btn.active');
                        if(activeFilterBtn) {
                            renderSpotsList(activeFilterBtn.dataset.filter);
                        }
                        alert("å®šä½å·²æ›´æ–°ï¼");
                    },
                    (error) => {
                        btn.innerText = "â†»";
                        alert("ç„¡æ³•ç²å–ä½ç½®: " + error.message);
                    }
                );
            } else {
                alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
            }
        }

        function renderSpotsList(filter = 'all') {
            if(!spotsListContainer) return;
            spotsListContainer.innerHTML = '';
            
            const refreshBtn = document.getElementById('refresh-loc-btn');
            if (filter !== 'all') {
                if(refreshBtn) refreshBtn.classList.remove('hidden');
            } else {
                if(refreshBtn) refreshBtn.classList.add('hidden');
            }

            const shouldSortByDist = (filter !== 'all' && userLocation.lat !== null);

            let displayData = [];

            if (filter === 'nearest') {
                if (!userLocation.lat) {
                    spotsListContainer.innerHTML = '<div class="text-center p-4 text-gray-500">æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...</div>';
                    refreshLocation(); 
                    return;
                }
                displayData = spotsData; 
            } else {
                displayData = filter === 'all' ? spotsData : spotsData.filter(s => s.type === filter);
            }

            if (userLocation.lat) {
                displayData = displayData.map(spot => {
                    const dist = calculateDistance(userLocation.lat, userLocation.lng, spot.lat, spot.lng);
                    return { ...spot, dist };
                });
            }

            if (filter === 'nearest' && userLocation.lat) {
                displayData.sort((a, b) => a.dist - b.dist);
                const nearSpots = displayData.filter(s => s.dist <= 1.0);
                if (nearSpots.length > 0) displayData = nearSpots;
                else displayData = [displayData[0]]; 
            }

            if (shouldSortByDist && filter !== 'nearest') {
                displayData.sort((a, b) => a.dist - b.dist);
            } else if (filter === 'all') {
                const typeOrder = { 'food': 1, 'shopping': 2, 'sightseeing': 3 };
                displayData.sort((a, b) => {
                    const typeDiff = (typeOrder[a.type] || 99) - (typeOrder[b.type] || 99);
                    if (typeDiff !== 0) return typeDiff;
                    return a.name.localeCompare(b.name, 'ja');
                });
            }
            
            if (displayData.length === 0) {
                 const msg = (filter === 'nearest') ? "é™„è¿‘æ²’æœ‰æ‰¾åˆ°åœ°é»ã€‚" : "æ­¤åˆ†é¡æ²’æœ‰è³‡æ–™ã€‚";
                 spotsListContainer.innerHTML = `<div class="text-center p-4 text-gray-500">${msg}</div>`;
                 return;
            }

            displayData.forEach(spot => {
                let badgeColor = ''; let typeLabel = '';
                switch(spot.type) {
                    case 'food': badgeColor = 'bg-jp-red text-white'; typeLabel = 'ç¾é£Ÿ'; break;
                    case 'shopping': badgeColor = 'bg-jp-gold text-white'; typeLabel = 'è³¼ç‰©'; break;
                    case 'sightseeing': badgeColor = 'bg-jp-brown text-white'; typeLabel = 'æ™¯é»'; break;
                }
                const card = document.createElement('div');
                card.className = "bg-white p-2 rounded border border-gray-200 spot-item";
                card.dataset.name = spot.name;
                card.onclick = (e) => { if(e.target.tagName !== 'A') updateMap(spot.name); };
                
                let linkHtml = spot.externalLink ? `<a href="${spot.externalLink}" target="_blank" class="text-blue-500 hover:text-blue-700 ml-1">ğŸ”—</a>` : '';
                
                let distHtml = '';
                if (spot.dist !== undefined) {
                    const distClass = spot.dist <= 1.0 ? 'dist-near' : '';
                    distHtml = `<span class="dist-badge ${distClass}">${formatDistance(spot.dist)}</span>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex-grow">
                            <h4 class="font-bold text-jp-brown text-sm flex items-center flex-wrap">
                                ${spot.name}
                                ${linkHtml}
                            </h4>
                        </div>
                        <div class="flex flex-col items-end gap-1 ml-2">
                            <span class="text-xs px-1.5 py-0.5 rounded ${badgeColor} whitespace-nowrap">${typeLabel}</span>
                            ${distHtml}
                        </div>
                    </div>
                    <p class="text-xs text-gray-600">${spot.note}</p>
                `;
                spotsListContainer.appendChild(card);
            });
        }

        function scrollToNavBtn(btn) {
            const container = document.getElementById('navbar-scroll-container');
            const scrollLeft = btn.offsetLeft - (container.offsetWidth / 2) + (btn.offsetWidth / 2);
            container.scrollTo({ left: scrollLeft, behavior: 'smooth' });
        }

        let touchStartX = 0; let touchStartY = 0; let touchEndX = 0; let touchEndY = 0;
        
        function switchTab(index) {
            if (index < 0 || index >= navBtns.length) return;
            const targetBtn = navBtns[index];
            navBtns.forEach(b => b.classList.remove('active'));
            sections.forEach(s => s.classList.remove('active'));
            targetBtn.classList.add('active');
            document.getElementById(targetBtn.dataset.section).classList.add('active');
            scrollToNavBtn(targetBtn);
        }

        navBtns.forEach((btn, index) => {
            btn.addEventListener('click', () => { switchTab(index); });
        });

        mainContent.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: true});
        mainContent.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; touchEndY = e.changedTouches[0].screenY; handleSwipe(); }, {passive: true});

        function handleSwipe() {
            const diffX = touchEndX - touchStartX;
            const diffY = touchEndY - touchStartY;
            if (Math.abs(diffX) > 50 && Math.abs(diffY) < 100) {
                let currentIndex = -1;
                navBtns.forEach((btn, index) => { if (btn.classList.contains('active')) currentIndex = index; });
                if (diffX > 0 && currentIndex > 0) switchTab(currentIndex - 1);
                else if (diffX < 0 && currentIndex < navBtns.length - 1) switchTab(currentIndex + 1);
            }
        }

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => { 
                filterBtns.forEach(b => b.classList.remove('active', 'bg-jp-brown', 'text-white')); 
                btn.classList.add('active', 'bg-jp-brown', 'text-white'); 
                renderSpotsList(btn.dataset.filter); 
            });
        });

        window.renderItinerary = function(dayId, btnElement) {
            if(btnElement) { document.querySelectorAll('.date-tab').forEach(t => t.classList.remove('active')); btnElement.classList.add('active'); }
            const container = document.getElementById('itinerary-content');
            const details = itineraryDetails[dayId];
            let html = `<div class="timeline-container">`;
            let dayTitle = ""; if(dayId === 'day1') dayTitle = "12/5 (äº”) ç®±æ ¹æº«æ³‰ä¹‹æ—…"; if(dayId === 'day2') dayTitle = "12/6 (å…­) æ©«é ˆè³€ & å…­æœ¬æœ¨"; if(dayId === 'day3') dayTitle = "12/7 (æ—¥) éŠ€æ & æ¾€è°·"; if(dayId === 'day4') dayTitle = "12/8 (ä¸€) æ·ºè‰ & éŠ€åº§"; if(dayId === 'day5') dayTitle = "12/9 (äºŒ) æ±äº¬è»Šç«™ & è¿”ç¨‹";
            html += `<h3 class="text-lg md:text-xl font-bold text-jp-gold mb-4 border-b border-jp-gold/30 pb-2">${dayTitle}</h3>`;
            details.forEach(item => {
                let recBadge = item.recommended ? `<div class="recommend-tag">âœ¨ ${item.recText || "æ¨è–¦"}</div>` : '';
                let diningHtml = '';
                if (item.diningOptions && item.diningOptions.length > 0) {
                    diningHtml += `<div class="dining-list"><div class="dining-header">ğŸ½ï¸ æ¨è–¦</div>`;
                    item.diningOptions.forEach(opt => {
                        let mapBadge = opt.inMap ? `<span class="in-map-badge">åœ°åœ–</span>` : '';
                        let linkIcon = opt.externalLink ? `<a href="${opt.externalLink}" target="_blank" class="text-blue-500 hover:text-blue-700 ml-1">ğŸ”—</a>` : '';
                        let priceTag = opt.price ? `<span class="text-[0.6rem] sm:text-xs text-gray-500 ml-1 sm:ml-2 bg-gray-100 px-1 rounded whitespace-nowrap">ğŸ’° ${opt.price}</span>` : '';
                        diningHtml += `<div class="dining-item"><div class="flex-grow"><span class="dining-name-link"><a href="${opt.mapUrl}" target="_blank" class="hover:text-jp-gold hover:underline flex items-center text-jp-brown">${opt.name}</a>${mapBadge}${linkIcon}${priceTag}</span><span class="dining-note">${opt.note}</span></div><span class="dining-rating">â˜…${opt.rating}</span></div>`;
                    });
                    diningHtml += `</div>`;
                }
                html += `<div class="detail-item"><div class="detail-time">${item.time}</div><div class="detail-title">${item.title}</div><div class="detail-desc">${item.desc}${recBadge}${diningHtml}</div></div>`;
            });
            html += `</div>`; container.innerHTML = html;
        }

        function updateMap(spotName) {
            const spot = spotsData.find(s => s.name === spotName); let query = spotName + " æ—¥æœ¬"; if (spot && spot.address) query = spot.address;
            mapFrame.src = `https://maps.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
            mapPlaceholder.style.display = 'none';
            document.querySelectorAll('.spot-item').forEach(el => { el.classList.remove('active-spot'); if (el.dataset.name === spotName) el.classList.add('active-spot'); });
        }

        function renderShoppingList() {
            if(!shoppingContainer) return;
            const categories = {}; 
            
            // Group items
            shoppingList.forEach(item => { 
                // Display Logic: If category is old "ç¾ç³éš±çœ¼", treat as "è—¥å¦ä¿é¤Š"
                let displayCat = item.category;
                if (displayCat === "ç¾ç³éš±çœ¼") displayCat = "è—¥å¦ä¿é¤Š";

                if(!categories[displayCat]) categories[displayCat] = []; 
                categories[displayCat].push(item); 
            });

            let html = '';
            // Define sort order if needed, otherwise loop through entries
            for (const [catName, items] of Object.entries(categories)) {
                html += `<div><h3 class="shop-category">${catName}</h3><div class="space-y-1">`;
                items.forEach((item) => {
                    let tagClass = ''; if(item.tag === 'Drugstore') tagClass = 'tag-drugstore'; if(item.tag === 'Variety') tagClass = 'tag-variety'; if(item.tag === 'Fashion') tagClass = 'tag-fashion'; if(item.tag === 'Contact') tagClass = 'tag-contact';
                    const uid = item.id; 
                    let imgLink = item.image ? `<a href="${item.image}" target="_blank" class="text-blue-500 ml-1 text-xs" title="æŸ¥çœ‹åœ–ç‰‡">ğŸ–¼ï¸ åœ–ç‰‡</a>` : ''; 
                    let extLink = item.externalLink ? `<a href="${item.externalLink}" target="_blank" class="text-blue-500 ml-1 text-xs" title="åº—é‹ªæŸ¥è©¢">ğŸ¬ åº—é‹ª</a>` : ''; 
                    let noteText = item.note ? `<div class="text-xs text-gray-500 mt-0.5">ğŸ’¡ ${item.note}</div>` : '';
                    
                    html += `
                    <div class="shop-item group relative" onclick="toggleShopItem(this)">
                        <input type="checkbox" class="mt-1 mr-2 cursor-pointer" id="${uid}">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <span class="font-bold text-jp-brown text-xs shop-name flex items-center flex-wrap gap-1">${item.name}${imgLink}${extLink}</span>
                                <span class="shop-tag ${tagClass}">${item.tag}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">ğŸ“ ${item.location}</div>
                            ${noteText}
                        </div>
                        <div class="flex ml-2 border-l pl-2 border-gray-100">
                             <button onclick="event.stopPropagation(); openShopEdit('${item.id}')" class="text-blue-400 hover:text-blue-600 mx-1 p-1">âœï¸</button>
                             <button onclick="event.stopPropagation(); openShopDelete('${item.id}')" class="text-red-400 hover:text-red-600 mx-1 p-1">ğŸ—‘ï¸</button>
                        </div>
                    </div>`;
                });
                html += `</div></div>`;
            }
            shoppingContainer.innerHTML = html;
        }

        window.toggleShopItem = (el) => {
            const checkbox = el.querySelector('input[type="checkbox"]');
            if(event.target.tagName === 'A' || event.target.tagName === 'BUTTON') return;
            
            if(event.target !== checkbox) checkbox.checked = !checkbox.checked;
            el.classList.toggle('checked', checkbox.checked);
        };

        window.closeModal = () => { document.getElementById('edit-modal').style.display = 'none'; };
        const flightModalEl = document.getElementById('flight-modal');
        window.openFlightModal = () => { flightModalEl.style.display = 'block'; };
        window.closeFlightModal = () => { flightModalEl.style.display = 'none'; };
        const accModalEl = document.getElementById('accommodation-modal');
        window.openAccommodationModal = () => { accModalEl.style.display = 'block'; };
        window.closeAccommodationModal = () => { accModalEl.style.display = 'none'; };
        
        // About Modal Functions
        window.openAboutModal = () => { 
            const modal = document.getElementById('about-modal');
            const versionDisplay = document.getElementById('version-display');
            const statusEl = document.getElementById('update-status');
            
            versionDisplay.innerText = `ç‰ˆæœ¬: ${APP_VERSION}`;
            statusEl.innerText = ''; 
            modal.style.display = 'block'; 
        };
        window.closeAboutModal = () => { document.getElementById('about-modal').style.display = 'none'; };

        window.checkForUpdates = async () => {
            const statusEl = document.getElementById('update-status');
            statusEl.innerText = 'è³¼ç‰©èˆ‡åœ°åœ–ä¿æŒå³æ™‚åŒæ­¥ä¸­ âœ…';
            statusEl.className = 'mb-4 text-sm font-bold h-6 text-green-600';
        };

        window.onclick = function(e) {
            if (e.target == document.getElementById('edit-modal')) closeModal();
            if (e.target == accModalEl) closeAccommodationModal();
            if (e.target == flightModalEl) closeFlightModal();
            if (e.target == document.getElementById('delete-modal')) closeDeleteModal();
            if (e.target == document.getElementById('about-modal')) closeAboutModal();
            if (e.target == document.getElementById('shop-edit-modal')) closeShopEditModal();
            if (e.target == document.getElementById('shop-delete-modal')) closeShopDeleteModal();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp(); 
            renderSpotsList('all'); 
            renderItinerary('day1', document.querySelector('.date-tab'));
            updateMap('Tokyo Station');
            
            if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(registration => {
                            globalRegistration = registration;
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration skipped/failed');
                        });
                });
            }
        });
    </script>
</body>
</html>